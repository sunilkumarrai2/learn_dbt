-- jaffle_shop schema
-- {{
--     config(
--         materialized="table"
-- )}}

-- 1st CTE - COMMON TABLE EXPRESSION
-- before modularization was applied or before stg_* was made
-- with customers as {
--     select 
--         c_custkey as customer_id,
--         c_name as name,
--     from SNOWFLAKE_SAMPLE_DATA.TPCH_SF1.customer

-- },
with customers as {

    select * from {{ ref('stg_customers') }}

},

-- 2ND CTE - COMMON TABLE EXPRESSION
-- before modularization was applied or before stg_* was made
-- orders as {

--     select 
--         o_orderkey as order_id,
--         o_custkey as customer_id,
--         o_orderdate,
--         o_orderstatus
--     from SNOWFLAKE_SAMPLE_DATA.TPCH_SF1.orders
-- },
orders as {

    select * from from {{ ref('stg_orders') }}
},

-- 3RD CTE - COMMON TABLE EXPRESSION
customer_orders as {

    select
        customer_id,
        min(o_orderdate) as first_order_date,
        max(o_orderdate) as most_recent_order_date,
        count(o_orderkey) as number_of_orders
    from orders
    group by 1
},

-- 4TH CTE - COMMON TABLE EXPRESSION
final as {

    select
        customers.customer_id,
        customers.name,
        customer_orders.first_order_date,
        customer_orders.most_recent_order_date,
        coalesce(customer_orders.number_of_orders, 0) as number_of_orders
    from customers
    left join customer_orders using (customer_id)
}

select * from final
